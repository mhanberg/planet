defmodule PlanetWeb.Support do
  @valid_attrs %{author: "some author", name: "some name", url: "some url"}

  def feed_fixture(attrs \\ %{}) do
    {:ok, rss} =
      attrs
      |> Enum.into(@valid_attrs)
      |> Planet.Feeds.create_rss()

    rss
  end

  def atom_fixture(authors, count \\ 1) do
    author = Keyword.get(authors, :author, "Mitchell Hanberg")
    entry_author = Keyword.get(authors, :entry, author)

    beginning = """
    <?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.7.3">Jekyll</generator><link href="https://www.mitchellhanberg.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://www.mitchellhanberg.com/" rel="alternate" type="text/html" /><updated>2018-06-03T22:29:43+00:00</updated><id>https://www.mitchellhanberg.com/</id><title type="html">Mitchell Hanberg’s Blog</title><author><name>#{
      author
    }</name></author>
    """

    entry = """
    <entry><title type="html">Integrate and Deploy React with Phoenix</title><link href="https://www.mitchellhanberg.com/post/2018/02/22/integrate-and-deploy-react-with-phoenix/" rel="alternate" type="text/html" title="Integrate and Deploy React with Phoenix" /><published>2018-02-22T12:00:00+00:00</published><updated>2018-02-22T12:00:00+00:00</updated><id>https://www.mitchellhanberg.com/post/2018/02/22/integrate-and-deploy-react-with-phoenix</id><content type="html" xml:base="https://www.mitchellhanberg.com/post/2018/02/22/integrate-and-deploy-react-with-phoenix/">&lt;blockquote&gt; &lt;p&gt;You’ve just finished your lightning fast Phoenix JSON API, what’s next?&lt;/p&gt; &lt;/blockquote&gt; &lt;h2 id=&quot;motivation&quot;&gt;Motivation&lt;/h2&gt; &lt;p&gt;&lt;img src=&quot;/images/contact.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt; &lt;p&gt;My most recent side project, &lt;a href=&quot;https://www.github.com/mhanberg/contact&quot;&gt;Contact&lt;/a&gt;, is a JSON REST API written with &lt;a href=&quot;https://elixir-lang.org/&quot;&gt;Elixir&lt;/a&gt; and &lt;a href=&quot;https://github.com/phoenixframework/phoenix&quot;&gt;Phoenix&lt;/a&gt;, designed to be the backend to an instant messaging application (e.g., Slack). There was a hackathon coming up at work, and I thought it’d be fun to make a frontend for Contact during it, and although Contact’s development was thoroughly test-driven, I wanted to make sure that my API was ready to be used.&lt;/p&gt; &lt;p&gt;The hackathon was two weeks away, so I needed to quickly prototype a UI to flesh out any oversights I made.&lt;/p&gt; &lt;p&gt;I decided to go with React over basic server-rendered html templates because my next project at work will be using React and figured I could use this to level up my skills.&lt;/p&gt; &lt;h2 id=&quot;lets-add-react&quot;&gt;Let’s add React!&lt;/h2&gt; &lt;p&gt;If you generated your Phoenix project using the &lt;code class=&quot;highlighter-rouge&quot;&gt;mix phx.new --no-html --no-brunch&lt;/code&gt; command, you’re good to go!&lt;/p&gt; &lt;p&gt;If not, let’s rip out the stock html and Javascript scaffolding that Phoenix generates for you. You can safely remove the &lt;code class=&quot;highlighter-rouge&quot;&gt;priv/assets&lt;/code&gt; directory (which contains all of the Brunch configuration) and &lt;code class=&quot;highlighter-rouge&quot;&gt;lib/&amp;lt;path to your web directory&amp;gt;/templates&lt;/code&gt;, along with any Phoenix views, controllers, and routes that you aren’t using.&lt;/p&gt; &lt;p&gt;A good place to install our React app is the &lt;code class=&quot;highlighter-rouge&quot;&gt;priv&lt;/code&gt; directory, so let’s move into there and run the installer.&lt;/p&gt; &lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# priv/&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;npx create-react-app contact-react &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;contact-react &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;yarn start &lt;span class=&quot;c&quot;&gt;# npm start if you don't use yarn&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt; &lt;p&gt;&lt;a href=&quot;/relativelink&quot;&gt;create-react-app&lt;/a&gt; gets us set up with React, Babel, and Webpack out of the box, allowing us to get started developing our application and not mess around with a ton of esoteric configuration.&lt;/p&gt; &lt;h2 id=&quot;success&quot;&gt;Success!&lt;/h2&gt; &lt;p&gt;We now have a development server running, serving the generated React application.&lt;/p&gt; &lt;p&gt;&lt;img src=&quot;https://www.mitchellhanberg.com/images/create-react-default.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt; &lt;h2 id=&quot;connecting-the-frontend-to-the-backend&quot;&gt;Connecting the frontend to the backend&lt;/h2&gt; &lt;p&gt;You may have noticed that your Phoenix server and the React development server are running on two different ports, how can we allow our two applications to communicate with each other?&lt;/p&gt; &lt;h3 id=&quot;development&quot;&gt;Development&lt;/h3&gt; &lt;p&gt;We’ll set up a proxy for development, so we won’t have to specify the absolute URI of the API endpoints we want to hit. Let’s add this line to our &lt;code class=&quot;highlighter-rouge&quot;&gt;package.json&lt;/code&gt;.&lt;/p&gt; &lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s2&quot;&gt;&quot;proxy&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://localhost:4000&quot;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt; &lt;p&gt;This line will set all network request URIs to be made relative to our Phoenix server.&lt;/p&gt; &lt;h3 id=&quot;production&quot;&gt;Production&lt;/h3&gt; &lt;p&gt;In production, we’ll have the Phoenix server send the frontend to the client.&lt;/p&gt; &lt;p&gt;To accomplish this, we’ll set up the root endpoint to serve the contents of the &lt;code class=&quot;highlighter-rouge&quot;&gt;build&lt;/code&gt; directory of our React app.&lt;/p&gt; &lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# endpoint.ex&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plug&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Static&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;IndexHtml&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;at:&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plug&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Static&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;at:&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;from:&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;priv/contact-react/build/&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;only:&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;~w(index.html favicon.ico static service-worker.js)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt; &lt;p&gt;&lt;a href=&quot;https://hex.pm/packages/plug_static_index_html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;Plug.Static.IndexHtml&lt;/code&gt;&lt;/a&gt; will allow us to serve the &lt;code class=&quot;highlighter-rouge&quot;&gt;index.html&lt;/code&gt; that Webpack generates from the root endpoint.&lt;/p&gt; &lt;p&gt;Now if we run &lt;code class=&quot;highlighter-rouge&quot;&gt;yarn build&lt;/code&gt;, start our Phoenix server, and navigate to &lt;code class=&quot;highlighter-rouge&quot;&gt;localhost:4000&lt;/code&gt; in the browser, we should see our React application!&lt;/p&gt; &lt;h2 id=&quot;deployment&quot;&gt;Deployment&lt;/h2&gt; &lt;p&gt;Since we have added another build step to our workflow, we’ll need to include that in our deployment process. I will describe the steps needed to deploy using &lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis CI&lt;/a&gt;.&lt;/p&gt; &lt;p&gt;I added a &lt;code class=&quot;highlighter-rouge&quot;&gt;before_deploy&lt;/code&gt; step and set the &lt;code class=&quot;highlighter-rouge&quot;&gt;skip_cleanup&lt;/code&gt; flag to the &lt;code class=&quot;highlighter-rouge&quot;&gt;deploy&lt;/code&gt; step to my &lt;code class=&quot;highlighter-rouge&quot;&gt;.travis.yml&lt;/code&gt; file, resembling the following.&lt;/p&gt; &lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;before_deploy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;rm -rf ~/.nvm &amp;amp;&amp;amp; curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash &amp;amp;&amp;amp; nvm install node &amp;amp;&amp;amp; nvm use node&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cd priv/contact-react &amp;amp;&amp;amp; yarn install &amp;amp;&amp;amp; yarn build &amp;amp;&amp;amp; cd -&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;deploy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;skip_cleanup&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt; &lt;p&gt;A breakdown of what is happening here:&lt;/p&gt; &lt;ul&gt; &lt;li&gt;Reinstall the latest version of &lt;a href=&quot;https://github.com/creationix/nvm&quot;&gt;Node Version Manager&lt;/a&gt;.&lt;/li&gt; &lt;li&gt;Install the latest version of Node.js.&lt;/li&gt; &lt;li&gt;Set the current version of Node.js to the one we just installed.&lt;/li&gt; &lt;li&gt;Build our React application (Yarn is already installed).&lt;/li&gt; &lt;li&gt;Tell Travis to deploy the compiled React application (otherwise, Travis would see the &lt;code class=&quot;highlighter-rouge&quot;&gt;build&lt;/code&gt; directory as a build artifact and clean it up before deployment).&lt;/li&gt; &lt;/ul&gt; &lt;h2 id=&quot;its-time-to-get-to-work&quot;&gt;It’s time to get to work!&lt;/h2&gt; &lt;p&gt;In 10 minutes we’ve gone from nothing to a deployed application!&lt;/p&gt; &lt;p&gt;Following these steps allowed me to get right to business; I was successful in prototyping 90% of my application before the hackathon.&lt;/p&gt; &lt;hr /&gt; &lt;h4 id=&quot;references&quot;&gt;References&lt;/h4&gt; &lt;ul&gt; &lt;li&gt;&lt;a href=&quot;http://www.petecorey.com/blog/2017/04/03/using-create-react-app-with-phoenix/&quot;&gt;http://www.petecorey.com/blog/2017/04/03/using-create-react-app-with-phoenix/&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=&quot;https://docs.travis-ci.com/user/deployment/heroku/#Deploying-build-artifacts&quot;&gt;https://docs.travis-ci.com/user/deployment/heroku/#Deploying-build-artifacts&lt;/a&gt;&lt;/li&gt; &lt;li&gt;&lt;a href=&quot;https://docs.travis-ci.com/user/deployment/heroku/#Running-commands-before-and-after-deploy&quot;&gt;https://docs.travis-ci.com/user/deployment/heroku/#Running-commands-before-and-after-deploy&lt;/a&gt;&lt;/li&gt; &lt;/ul&gt;</content><author><name>#{
      entry_author
    }</name></author></entry>
    """

    ehnd = ~s(</feed>)

    beginning <> String.duplicate(entry, count) <> ehnd
  end

  def pry(passthrough) do
    require IEx
    IEx.pry()

    passthrough
  end
end
